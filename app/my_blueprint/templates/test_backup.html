{% extends "template.html" %}
{% block head %}
{% endblock %}



{% block content %}
<script src="https://d3js.org/d3.v5.min.js"></script>

<script src="{{ url_for('my_blueprint.static', filename='constants.js') }}"></script>
<script src="{{ url_for('my_blueprint.static', filename='colorconversion.js') }}"></script>



        <div>
<h1>Emphasis in Visualization</h1>

<p>Please view the scatter plot and Press the "F" key if a point
            appears to be emphasized (that is, appears to be different to the rest) and the "J" key if there is no emphasized point.</p>

    </div>
<br><br>
<div id="stimulus" width="1200px" height="900px"></div>



<script>

// Stimulus set variables
	var colors = [[[50, 0, 40], [50, 0, 40]], [[50, 0, 10], [50, 0, 50]], [[60, 0, 40], [30, 0, 50]]];

	// Active stimulus variables
	var trial = 0;
	var color = [];
	var size = 0;
	var userId = 0;
	var start1, start2 = 0;
	var query="";
	var resp;
	var activeColor;
	var adjustedColor;
	var respInt;
    var positions = [];
    var adjustedSize = [20, 200];
    var distractors = [];// not used
    var gap;

    var GRID_PAD = 50;

    console.log("yee haa")

	$(document).ready(function() {
			// Parse the query variables
			t = new Date();
			query = window.location.search;
			if (query.substring(0, 1) == '?')
				query = query.substring(1);
			userId = parseInt(query.substring(0, query.indexOf("&")));

			// Establish the display layout
			var d = query.substring(query.indexOf("-d=") + 3);
			size = 20;//visualAngleToPixels(2.0,parseFloat(d*24), document.getElementById("dpi").offsetHeight)/2;
			gap = visualAngleToPixels(6.0,30, 96)/2;
			/*if (2*size + gap > $("#stimulus").width) {
				$("#stimulus").width(2*size + gap);
			}*/
            $("#stimulus").height(400);
//			var w = $("#stimulus").width();
            var width = 4*gap + 2 * GRID_PAD + size;
			start1 = width * 0.5  - 0.5*gap;
			start2 = gap + 20 + start1;
			trial = 0;

			// Instantiate the input
			$(this).keyup(function(evt){
			  console.log(evt)
			  if (evt.which == 70) {
				resp = 0
				// This is in Stimuli.js. For flickering the blank screen
				adapt(false);
			  }
			  if (evt.which == 74) {
				resp = 1;
				adapt(false);
			  }
			});

            colorType = COLORTYPE.Lab;
			drawStimulus(colors[trial][0], colors[trial][1], gap);
	});



	var drawStimulus = function(c1, c2, gap, showTarget) {

        var width = 4*gap + 2 * GRID_PAD + 2*size,
        height = $("#stimulus").height();

        generatePositions(start1, start2, c1, c2, gap);

        // Remove any existing SVG on the page
        d3.select("svg").remove();

        var svg = d3.select("body").select("div #stimulus")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height);

        center = 0.5*width;

        console.log("here")

        var data = [10, 15, 20, 25, 30];

        var xscale = d3.scaleLinear()
            .domain([0, d3.max(data)])
            .range([5, width-5]);

        var yscale = d3.scaleLinear()
                .domain([0, d3.max(data)])
                .range([height-GRID_PAD, 0]);

        var x_axis = d3.axisBottom()
                .scale(xscale);

        var y_axis = d3.axisLeft()
                .scale(yscale);

     // Add y-axis
          svg.append("g")
              .attr("class", "axis")
              .attr("transform", "translate(5, 0)")
              .call(y_axis);

      // Add X-axis
      svg.append("g")
          .attr("class", "axis")
          .attr("transform", "translate(0," + (height - GRID_PAD + 1) + ")")
          .call(x_axis);


        console.log("yooo")
        console.log(svg)
        renderSingleMark(svg);




	};

	function normal(mu, sigma, nsamples){
    if(!nsamples) nsamples = 6
    if(!sigma) sigma = 1
    if(!mu) mu=0

    var run_total = 0
    for(var i=0 ; i<nsamples ; i++){
       run_total += Math.random()
    }

    return sigma*(run_total - nsamples/2)/(nsamples/2) + mu
    };

    // The maximum is exclusive and the minimum is inclusive
    function getRandomInt(min, max) {
      min = Math.ceil(min);
      max = Math.floor(max);
      return Math.floor(Math.random() * (max - min)) + min;
    }

    function intersect(p1, p2, r){
        return Math.sqrt(Math.pow(p1[0] - p2[0], 2) + Math.pow(p1[1] - p2[1], 2)) < r;
    };


    function buildPosition(h, x, y, c, p, l, shape) {
    distractors.push(h);
    return [
        [adjustedSize[0], h],
        c.slice(0),
        x,
        y,
        p,
        l,
        shape
    ];
    };



    function generatePositions(x1, x2, c1, c2, proximity) {
		// Constant Shape
        var rightX = x1;
        var leftX = x2;
        var height = Math.abs(normal(.5, 1.0, 10)* $("#stimulus").height()  - 10);

       // Distractor shapes
        // Density is essentially half full
        var numDistractors = Math.pow(700*400 / (400), 1.0/3.0);
        var distractorColor = [50, 0, 0];

        // Check for overdraw and don't draw if there is any with the target points
        var points = [[leftX, $("#stimulus").height()/2- 20], [rightX, $("#stimulus").height()/2 - 20]];
        for (var i = 0; i < numDistractors; i++) {
            // Pick coords
            var x = getRandomInt(50, 350);
            var y = getRandomInt(50, 300);

            // Check for conflict
            var intersectsPoint = false;
            for (var p = 0; p < points.length; p++) {
                intersectsPoint = intersect(points[p], [x, y], 20) || intersectsPoint;
                if (intersectsPoint){
                    break;
                }
            }

            if (!intersectsPoint){
                positions.push(buildPosition(adjustedSize[0], x, y, distractorColor.slice(0), 0, 0, "circle"));
                points.push([x, y]);
            }
        }

        if (trial != 0) {
            positions.push([
                [20, 20],	// Size
                c2.slice(0), // Color
                rightX, // X
                $("#stimulus").height() / 2 - 20, // Y
                0, // Not used
                0, // Position of the fixed (non-jittered color)
                "circle"
            ]);
        }

		// Adjusted Shape
		/*positions.push([
							[20, 20],
							c2.slice(0),
							leftX,
							 $("#stimulus").height()/2 - 20,
							 $("#stimulus").height()/2 - 20,
							0,
							0,
							"circle"
						]);*/
    };


	var logResponse = function() {
		// Fetch the current slider color
		var curColor = color.slice(0);
		clearInterval(respInt);
		if (trial == 0) {
			if (resp == 1){
				alert("Correct.");
			} else {
				alert("Incorrect.  Press the 'F' key if a point appears to be emphasized (that is, appears to be different to the rest) and the 'J' key if there is no emphasized point." );
				trial--;
			}
		} else if (trial == 1) {
			if (resp == 0){
				alert("Correct.");
			} else {
				alert("Incorrect.  Press the 'F' key if a point appears to be emphasized (that is, appears to be different to the rest) and the 'J' key if there is no emphasized point."  );
				trial--;
			}
		} else {
			if (resp == 0){
				alert("Correct. Press 'OK' to exit this window and begin the study.");
				postResponseValues(resp);
			} else {
				alert("Incorrect.  Press the 'F' key if a point appears to be emphasized (that is, appears to be different to the rest) and the 'J' key if there is no emphasized point." );
				trial--;
			}
		}

		trial++;
		drawStimulus(colors[trial][0], colors[trial][1], gap);
	};

	var postResponseValues = function(response) {
	    var practiceResult = {
	        response: resp
        };
        $.post("#", practiceResult).then(function(){
            // I NEED TO MOVE TO THE NEXT PAGE HERE (E.G., FOR NOW, END)

            window.location.href = "/redirect_next_page";
        })
	};



</script>

{% endblock %}